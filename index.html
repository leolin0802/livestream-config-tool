<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›´æ’­ç´ ææ¡†é…ç½®å·¥å…·</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">ç›´æ’­ç´ ææ¡†é…ç½®å·¥å…·</h1>
            <p class="subtitle">æ™ºèƒ½åŒ–è™•ç†ç›´æ’­å»£å‘Šç´ æé…ç½®èˆ‡ç‰ˆå‹ç®¡ç†</p>
        </div>
        
        <div class="main-grid">
            <div class="card">
                <h2 class="card-title">åŸºæœ¬è¨­å®š</h2>
                <div class="form-group">
                    <label for="advertiserId">Advertiser ID</label>
                    <input type="number" id="advertiserId" placeholder="205">
                </div>
                <div class="form-group">
                    <label for="campaignName">Campaign Name</label>
                    <input type="text" id="campaignName" placeholder="ä¾‹: 0627_ç›´æ’­_ç›´å¼">
                </div>
                <div class="form-group">
                    <label for="destinationUrl">Destination URL</label>
                    <input type="url" id="destinationUrl" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label for="facebookVideoUrl">Facebook Video URL</label>
                    <input type="url" id="facebookVideoUrl" placeholder="https://...">
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title">åœ–ç‰‡è³‡æ–™</h2>
                <div class="form-group">
                    <label for="apiResponse">API Response JSON</label>
                    <textarea id="apiResponse" placeholder='è²¼ä¸Šåœ–ç‰‡ä¸Šå‚³ API çš„å›æ‡‰ JSON...'></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="startAutoCapture()">ğŸ”„ è‡ªå‹•ç›£è½</button>
                    <button class="btn btn-secondary" onclick="stopAutoCapture()">â¹ï¸ åœæ­¢</button>
                </div>
                <div id="captureStatus" style="margin-top: 8px; font-size: 12px; color: #6b7280;"></div>
            </div>
        </div>
        
        <div class="status-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 class="card-title" style="margin-bottom: 0;">åœ–ç‰‡åŒ¹é…ç‹€æ…‹</h2>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="toggleStatusEditMode()" id="statusEditBtn">ç·¨è¼¯</button>
                    <button class="btn btn-secondary" onclick="resetToDefaultTemplates()">é‡ç½®ç‹€æ…‹æª¢æŸ¥</button>
                    <button class="btn btn-danger" onclick="resetAllTemplates()">å®Œå…¨é‡ç½®</button>
                </div>
            </div>
            <div id="statusGrid" class="status-grid"></div>
            <div id="statusEditPanel" style="display: none; margin-top: 16px; padding: 16px; background: #f9fafb; border-radius: 8px;">
                <h4 style="margin-bottom: 12px; color: #374151;">é¸æ“‡è¦æª¢æŸ¥çš„ç‰ˆå‹å°ºå¯¸ï¼š</h4>
                <div id="statusCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;"></div>
                <div class="btn-group" style="margin-top: 12px;">
                    <button class="btn" onclick="applyStatusSelection()">å¥—ç”¨é¸æ“‡</button>
                    <button class="btn btn-secondary" onclick="cancelStatusEdit()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
        
        <div class="templates-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 class="card-title" style="margin-bottom: 0;">ç‰ˆå‹ç®¡ç†</h2>
                <div class="btn-group">
                    <button class="btn" onclick="addNewTemplate()">æ–°å¢ç‰ˆå‹</button>
                    <button class="btn btn-secondary" onclick="openTemplateEditor()">ç·¨è¼¯ç‰ˆå‹</button>
                </div>
            </div>
            <div id="templatesDisplay" class="template-grid"></div>
        </div>
        
        <div class="center">
            <button class="btn" onclick="validateAndGenerate()" style="padding: 12px 32px; font-size: 16px;">ç”Ÿæˆé…ç½®</button>
        </div>
        
        <div id="outputSection"></div>
    </div>
    
    <!-- ç‰ˆå‹ç·¨è¼¯å™¨ Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ç‰ˆå‹ç·¨è¼¯å™¨</h3>
                <button class="close-btn" onclick="closeTemplateEditor()">&times;</button>
            </div>
            <div id="templateEditorContent"></div>
            <div class="btn-group" style="margin-top: 16px;">
                <button class="btn" onclick="saveTemplates()">ğŸ’¾ å„²å­˜ç‰ˆå‹</button>
                <button class="btn btn-secondary" onclick="closeTemplateEditor()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <!-- æ–°å¢ç‰ˆå‹ Modal -->
    <div id="addTemplateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ–°å¢ç‰ˆå‹</h3>
                <button class="close-btn" onclick="closeAddTemplateModal()">&times;</button>
            </div>
            <div id="addTemplateContent">
                <div class="form-group">
                    <label>ç‰ˆå‹é¡å‹</label>
                    <select id="newTemplateType" class="editor-input" style="width: 100%;">
                        <option value="horizontal">æ©«å¼</option>
                        <option value="vertical">ç›´å¼</option>
                    </select>
                </div>
                <div class="editor-row">
                    <div class="form-group">
                        <label>å¯¬åº¦ (Width)</label>
                        <input type="number" id="newTemplateWidth" class="editor-input" placeholder="ä¾‹: 300">
                    </div>
                    <div class="form-group">
                        <label>é«˜åº¦ (Height)</label>
                        <input type="number" id="newTemplateHeight" class="editor-input" placeholder="ä¾‹: 250">
                    </div>
                </div>
                <h4 style="margin: 16px 0 8px 0; color: #374151;">LiveStream Box è¨­å®š</h4>
                <div class="editor-row">
                    <div class="form-group">
                        <label>Left</label>
                        <input type="number" id="newTemplateLeft" class="editor-input" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Top</label>
                        <input type="number" id="newTemplateTop" class="editor-input" placeholder="0">
                    </div>
                </div>
                <div class="editor-row">
                    <div class="form-group">
                        <label>Stream Width</label>
                        <input type="number" id="newTemplateStreamWidth" class="editor-input" placeholder="ä¾‹: 280">
                    </div>
                    <div class="form-group">
                        <label>Stream Height</label>
                        <input type="number" id="newTemplateStreamHeight" class="editor-input" placeholder="ä¾‹: 182">
                    </div>
                </div>
            </div>
            <div class="btn-group" style="margin-top: 16px;">
                <button class="btn" onclick="saveNewTemplate()">æ–°å¢ç‰ˆå‹</button>
                <button class="btn btn-secondary" onclick="closeAddTemplateModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <!-- ç¢ºèª Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">âš ï¸ æœ€çµ‚ç¢ºèª</h3>
                <button class="close-btn" onclick="closeConfirmModal()">&times;</button>
            </div>
            <div id="confirmContent"></div>
            <div class="btn-group" style="margin-top: 16px;">
                <button class="btn" onclick="finalGenerate()">âœ… ç¢ºèªç”Ÿæˆ</button>
                <button class="btn btn-danger" onclick="closeConfirmModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        let templates = {
            horizontal: [
                { width: 970, height: 250, liveStreamBox: { left: 301, top: 6, width: 368, height: 240 } },
                { width: 300, height: 250, liveStreamBox: { left: 10, top: 34, width: 280, height: 182 } },
                { width: 336, height: 280, liveStreamBox: { left: 8, top: 36, width: 320, height: 208 } },
                { width: 320, height: 480, liveStreamBox: { left: 20, top: 155, width: 280, height: 184 } },
                { width: 300, height: 600, liveStreamBox: { left: 10, top: 209, width: 280, height: 184 } }
            ],
            vertical: [
                { width: 970, height: 250, liveStreamBox: { left: 415, top: 0, width: 140, height: 250 } },
                { width: 300, height: 250, liveStreamBox: { left: 0, top: 0, width: 142, height: 250 } },
                { width: 336, height: 280, liveStreamBox: { left: 0, top: 0, width: 159, height: 280 } },
                { width: 320, height: 480, liveStreamBox: { left: 0, top: 0, width: 270, height: 480 } },
                { width: 300, height: 600, liveStreamBox: { left: 0, top: 0, width: 300, height: 534 } }
            ]
        };
        
        let currentImages = [];
        let isMonitoring = false;
        let originalFetch = null;
        let activeStatusTemplates = [];
        let isStatusEditMode = false;
        
        // æœ¬åœ°å­˜å„²åŠŸèƒ½
        function saveTemplatesToStorage() {
            localStorage.setItem('liveStreamTemplates', JSON.stringify(templates));
            localStorage.setItem('activeStatusTemplates', JSON.stringify(activeStatusTemplates));
        }

        function loadTemplatesFromStorage() {
            const savedTemplates = localStorage.getItem('liveStreamTemplates');
            const savedActiveStatus = localStorage.getItem('activeStatusTemplates');
            
            if (savedTemplates) {
                templates = JSON.parse(savedTemplates);
            }
            
            if (savedActiveStatus) {
                activeStatusTemplates = JSON.parse(savedActiveStatus);
            } else {
                activeStatusTemplates = [...getUniqueTemplates()];
            }
        }

        function getUniqueTemplates() {
            const allDimensions = [...templates.horizontal, ...templates.vertical];
            return allDimensions.filter((item, index, self) => 
                index === self.findIndex(t => t.width === item.width && t.height === item.height)
            );
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            loadTemplatesFromStorage();
            updateTemplatesDisplay();
            loadExampleData();
            updateStatus();
        });
        
        function loadExampleData() {
            document.getElementById('advertiserId').value = '205';
            document.getElementById('destinationUrl').value = 'https://www.facebook.com/Wstyle2016/videos/1037160801080675';
            document.getElementById('facebookVideoUrl').value = 'https://www.facebook.com/Wstyle2016/videos/1078151107551607';
        }
        
        function updateTemplatesDisplay() {
            const container = document.getElementById('templatesDisplay');
            container.innerHTML = '';
            
            ['horizontal', 'vertical'].forEach(type => {
                const typeDiv = document.createElement('div');
                typeDiv.className = 'template-type';
                typeDiv.innerHTML = `
                    <div class="template-type-title">${type === 'horizontal' ? 'æ©«å¼ç‰ˆå‹' : 'ç›´å¼ç‰ˆå‹'}</div>
                    ${templates[type].map(t => `
                        <div class="template-item">
                            <div class="template-name">${t.width}Ã—${t.height}</div>
                            <div class="dimensions">StreamBox: ${t.liveStreamBox.left},${t.liveStreamBox.top},${t.liveStreamBox.width},${t.liveStreamBox.height}</div>
                        </div>
                    `).join('')}
                `;
                container.appendChild(typeDiv);
            });
        }
        
        function updateStatus() {
            const container = document.getElementById('statusGrid');
            
            container.innerHTML = activeStatusTemplates.map(dim => {
                const hasImage = currentImages.some(img => img.width === dim.width && img.height === dim.height);
                return `
                    <div class="status-item ${hasImage ? 'status-filled' : 'status-missing'}">
                        ${dim.width}Ã—${dim.height}<br>
                        ${hasImage ? 'å·²åŒ¹é…' : 'æœªåŒ¹é…'}
                    </div>
                `;
            }).join('');
        }
        
        // æ–°å¢ç‰ˆå‹åŠŸèƒ½
        function addNewTemplate() {
            document.getElementById('addTemplateModal').style.display = 'block';
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('newTemplateWidth').value = '';
            document.getElementById('newTemplateHeight').value = '';
            document.getElementById('newTemplateLeft').value = '0';
            document.getElementById('newTemplateTop').value = '0';
            document.getElementById('newTemplateStreamWidth').value = '';
            document.getElementById('newTemplateStreamHeight').value = '';
        }

        function closeAddTemplateModal() {
            document.getElementById('addTemplateModal').style.display = 'none';
        }

        function saveNewTemplate() {
            const type = document.getElementById('newTemplateType').value;
            const width = parseInt(document.getElementById('newTemplateWidth').value);
            const height = parseInt(document.getElementById('newTemplateHeight').value);
            const left = parseInt(document.getElementById('newTemplateLeft').value) || 0;
            const top = parseInt(document.getElementById('newTemplateTop').value) || 0;
            const streamWidth = parseInt(document.getElementById('newTemplateStreamWidth').value);
            const streamHeight = parseInt(document.getElementById('newTemplateStreamHeight').value);
            
            if (!width || !height || !streamWidth || !streamHeight) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼');
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒå°ºå¯¸
            const exists = templates[type].some(t => t.width === width && t.height === height);
            if (exists) {
                alert('è©²å°ºå¯¸å·²å­˜åœ¨æ–¼æ­¤ç‰ˆå‹ä¸­ï¼');
                return;
            }
            
            const newTemplate = {
                width: width,
                height: height,
                liveStreamBox: {
                    left: left,
                    top: top,
                    width: streamWidth,
                    height: streamHeight
                }
            };
            
            templates[type].push(newTemplate);
            activeStatusTemplates = [...getUniqueTemplates()]; // é‡æ–°è¨ˆç®—
            
            saveTemplatesToStorage();
            updateTemplatesDisplay();
            updateStatus();
            closeAddTemplateModal();
            alert('æ–°ç‰ˆå‹å·²æ–°å¢ï¼');
        }

        // ç‹€æ…‹ç·¨è¼¯åŠŸèƒ½
        function toggleStatusEditMode() {
            isStatusEditMode = !isStatusEditMode;
            const editBtn = document.getElementById('statusEditBtn');
            const editPanel = document.getElementById('statusEditPanel');
            
            if (isStatusEditMode) {
                editBtn.textContent = 'å–æ¶ˆç·¨è¼¯';
                editBtn.className = 'btn btn-danger';
                editPanel.style.display = 'block';
                document.body.classList.add('status-edit-mode');
                updateStatusCheckboxes();
            } else {
                editBtn.textContent = 'ç·¨è¼¯';
                editBtn.className = 'btn btn-secondary';
                editPanel.style.display = 'none';
                document.body.classList.remove('status-edit-mode');
            }
        }

        function updateStatusCheckboxes() {
            const container = document.getElementById('statusCheckboxes');
            const allTemplates = getUniqueTemplates();
            
            container.innerHTML = allTemplates.map(template => {
                const isActive = activeStatusTemplates.some(t => t.width === template.width && t.height === template.height);
                return `
                    <div class="checkbox-item">
                        <input type="checkbox" id="template_${template.width}_${template.height}" 
                               ${isActive ? 'checked' : ''}>
                        <label for="template_${template.width}_${template.height}">${template.width}Ã—${template.height}</label>
                    </div>
                `;
            }).join('');
        }

        function applyStatusSelection() {
            const allTemplates = getUniqueTemplates();
            activeStatusTemplates = allTemplates.filter(template => {
                const checkbox = document.getElementById(`template_${template.width}_${template.height}`);
                return checkbox && checkbox.checked;
            });
            
            saveTemplatesToStorage();
            updateStatus();
            toggleStatusEditMode();
            alert('ç‹€æ…‹æª¢æŸ¥è¨­å®šå·²æ›´æ–°ï¼');
        }

        function cancelStatusEdit() {
            toggleStatusEditMode();
        }

        // ä¿®æ­£é‡ç½®åŠŸèƒ½ - åªé‡ç½®ç‹€æ…‹æª¢æŸ¥ï¼Œä¸åˆªé™¤ç”¨æˆ¶ç‰ˆå‹
        function resetToDefaultTemplates() {
            if (confirm('ç¢ºå®šè¦é‡ç½®åŒ¹é…ç‹€æ…‹ç‚ºé è¨­çš„5ç¨®ç‰ˆå‹æª¢æŸ¥å—ï¼Ÿï¼ˆä¸æœƒåˆªé™¤æ‚¨æ–°å¢çš„ç‰ˆå‹ï¼‰')) {
                // åªé‡ç½®é è¨­çš„5ç¨®ç‰ˆå‹ä½œç‚ºç‹€æ…‹æª¢æŸ¥
                const defaultTemplates = [
                    { width: 970, height: 250 },
                    { width: 300, height: 250 },
                    { width: 336, height: 280 },
                    { width: 320, height: 480 },
                    { width: 300, height: 600 }
                ];
                
                activeStatusTemplates = defaultTemplates;
                saveTemplatesToStorage();
                updateStatus();
                alert('å·²é‡ç½®ç‹€æ…‹æª¢æŸ¥ç‚ºé è¨­5ç¨®ç‰ˆå‹ï¼');
            }
        }

        // æ–°å¢ï¼šå®Œå…¨é‡ç½®åŠŸèƒ½ï¼ˆå¦‚æœçœŸçš„éœ€è¦ï¼‰
        function resetAllTemplates() {
            if (confirm('âš ï¸ è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰è‡ªè¨‚ç‰ˆå‹ï¼Œé‡ç½®ç‚ºåŸå§‹ç‹€æ…‹ï¼\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                // é‡ç½®ç‚ºåŸå§‹é è¨­ç‰ˆå‹
                templates = {
                    horizontal: [
                        { width: 970, height: 250, liveStreamBox: { left: 301, top: 6, width: 368, height: 240 } },
                        { width: 300, height: 250, liveStreamBox: { left: 10, top: 34, width: 280, height: 182 } },
                        { width: 336, height: 280, liveStreamBox: { left: 8, top: 36, width: 320, height: 208 } },
                        { width: 320, height: 480, liveStreamBox: { left: 20, top: 155, width: 280, height: 184 } },
                        { width: 300, height: 600, liveStreamBox: { left: 10, top: 209, width: 280, height: 184 } }
                    ],
                    vertical: [
                        { width: 970, height: 250, liveStreamBox: { left: 415, top: 0, width: 140, height: 250 } },
                        { width: 300, height: 250, liveStreamBox: { left: 0, top: 0, width: 142, height: 250 } },
                        { width: 336, height: 280, liveStreamBox: { left: 0, top: 0, width: 159, height: 280 } },
                        { width: 320, height: 480, liveStreamBox: { left: 0, top: 0, width: 270, height: 480 } },
                        { width: 300, height: 600, liveStreamBox: { left: 0, top: 0, width: 300, height: 534 } }
                    ]
                };
                
                activeStatusTemplates = [...getUniqueTemplates()];
                saveTemplatesToStorage();
                updateTemplatesDisplay();
                updateStatus();
                alert('å·²å®Œå…¨é‡ç½®ç‚ºé è¨­ç‰ˆå‹ï¼');
            }
        }
        
        function detectTypeFromFilenames(images) {
            let verticalCount = 0;
            let horizontalCount = 0;
            
            images.forEach(img => {
                if (img.filename && img.filename.includes('ç›´å¼')) verticalCount++;
                if (img.filename && img.filename.includes('æ©«å¼')) horizontalCount++;
            });
            
            return verticalCount > horizontalCount ? 'vertical' : 
                   horizontalCount > verticalCount ? 'horizontal' : null;
        }
        
        function detectTypeFromName(name) {
            if (name.includes('ç›´å¼')) return 'vertical';
            if (name.includes('æ©«å¼')) return 'horizontal';
            return null;
        }
        
        function validateAndGenerate() {
            const apiResponseText = document.getElementById('apiResponse').value.trim();
            const campaignName = document.getElementById('campaignName').value.trim();
            const advertiserId = document.getElementById('advertiserId').value.trim();
            const destinationUrl = document.getElementById('destinationUrl').value.trim();
            const facebookVideoUrl = document.getElementById('facebookVideoUrl').value.trim();
            
            if (!apiResponseText || !campaignName || !advertiserId || !destinationUrl || !facebookVideoUrl) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼');
                return;
            }
            
            try {
                const apiResponse = JSON.parse(apiResponseText);
                currentImages = apiResponse.data || [];
                
                if (!currentImages.length) {
                    alert('API Response ä¸­æ²’æœ‰æ‰¾åˆ°åœ–ç‰‡è³‡æ–™ï¼');
                    return;
                }
                
                const unknownSizes = checkForUnknownSizes(currentImages);
                if (unknownSizes.length > 0) {
                    alert(`ç™¼ç¾æœªçŸ¥å°ºå¯¸: ${unknownSizes.map(s => `${s.width}Ã—${s.height}`).join(', ')}\nè«‹å…ˆç·¨è¼¯ç‰ˆå‹åŠ å…¥é€™äº›å°ºå¯¸ï¼`);
                    openTemplateEditor();
                    return;
                }
                
                const imageType = detectTypeFromFilenames(currentImages);
                const nameType = detectTypeFromName(campaignName);
                
                if (imageType && nameType && imageType !== nameType) {
                    const imageTypeName = imageType === 'vertical' ? 'ç›´å¼' : 'æ©«å¼';
                    const nameTypeName = nameType === 'vertical' ? 'ç›´å¼' : 'æ©«å¼';
                    
                    if (!confirm(`æª¢æ¸¬åˆ°é¡å‹ä¸ä¸€è‡´:\nåœ–ç‰‡æª”åé¡¯ç¤º: ${imageTypeName}\nCampaign Name é¡¯ç¤º: ${nameTypeName}\n\né»æ“Šç¢ºå®šä½¿ç”¨åœ–ç‰‡æª”åçš„é¡å‹ (${imageTypeName})ï¼Œé»æ“Šå–æ¶ˆé‡æ–°æª¢æŸ¥ã€‚`)) {
                        return;
                    }
                }
                
                const missingImages = checkMissingImages(currentImages);
                if (missingImages.length > 0) {
                    if (!confirm(`ç¼ºå°‘ä»¥ä¸‹å°ºå¯¸çš„åœ–ç‰‡:\n${missingImages.map(s => `${s.width}Ã—${s.height}`).join('\n')}\n\nè«‹ç¢ºèªæ˜¯å¦è¦ç¹¼çºŒç”Ÿæˆï¼ˆç¼ºå°‘çš„å°ºå¯¸å°‡ä¿æŒç©ºç™½ï¼‰ï¼Ÿ`)) {
                        return;
                    }
                }
                
                showFinalConfirmation();
                
            } catch (error) {
                alert('API Response JSON æ ¼å¼éŒ¯èª¤ï¼');
            }
        }
        
        function checkForUnknownSizes(images) {
            const knownSizes = [...templates.horizontal, ...templates.vertical];
            return images.filter(img => 
                !knownSizes.some(t => t.width === img.width && t.height === img.height)
            );
        }
        
        function checkMissingImages(images) {
            const campaignName = document.getElementById('campaignName').value;
            const imageType = detectTypeFromFilenames(images) || detectTypeFromName(campaignName) || 'vertical';
            const requiredSizes = templates[imageType];
            
            return requiredSizes.filter(size => 
                !images.some(img => img.width === size.width && img.height === size.height)
            );
        }
        
        function showFinalConfirmation() {
            const campaignName = document.getElementById('campaignName').value;
            const imageType = detectTypeFromFilenames(currentImages) || detectTypeFromName(campaignName) || 'vertical';
            const typeName = imageType === 'vertical' ? 'ç›´å¼' : 'æ©«å¼';
            const matchedCount = countMatchedImages();
            const totalCount = templates[imageType].length;
            
            document.getElementById('confirmContent').innerHTML = `
                <div class="success">
                    <strong>é…ç½®æ‘˜è¦ï¼š</strong><br>
                    Campaign: ${campaignName}<br>
                    é¡å‹: ${typeName}<br>
                    åŒ¹é…ç‹€æ…‹: ${matchedCount}/${totalCount}<br>
                    VideoOrientation: ${imageType === 'vertical' ? 'PORTRAIT' : 'LANDSCAPE'}
                </div>
                <p>ç¢ºèªä»¥ä¸Šè³‡æ–™ç„¡èª¤å¾Œï¼Œé»æ“Šç¢ºèªç”Ÿæˆæœ€çµ‚é…ç½®æª”æ¡ˆã€‚</p>
            `;
            
            document.getElementById('confirmModal').style.display = 'block';
        }
        
        function countMatchedImages() {
            const campaignName = document.getElementById('campaignName').value;
            const imageType = detectTypeFromFilenames(currentImages) || detectTypeFromName(campaignName) || 'vertical';
            const requiredSizes = templates[imageType];
            
            return requiredSizes.filter(size => 
                currentImages.some(img => img.width === size.width && img.height === size.height)
            ).length;
        }
        
        function finalGenerate() {
            const campaignName = document.getElementById('campaignName').value;
            const advertiserId = parseInt(document.getElementById('advertiserId').value);
            const destinationUrl = document.getElementById('destinationUrl').value;
            const facebookVideoUrl = document.getElementById('facebookVideoUrl').value;
            
            const imageType = detectTypeFromFilenames(currentImages) || detectTypeFromName(campaignName) || 'vertical';
            const templateData = templates[imageType];
            
            const backgroundImages = templateData.map(template => {
                const matchingImage = currentImages.find(img => 
                    img.width === template.width && img.height === template.height
                );
                
                return {
                    imageId: matchingImage ? matchingImage.id : "",
                    destinationUrl: destinationUrl,
                    displayedDimensions: { width: template.width, height: template.height },
                    liveStreamBox: template.liveStreamBox,
                    impressionTrackingTags: []
                };
            });
            
            const result = {
                input: {
                    advertiserId: advertiserId,
                    name: campaignName,
                    backgroundImages: backgroundImages,
                    facebookVideoUrl: facebookVideoUrl,
                    clickThroughUrls: [destinationUrl],
                    renderType: "SDK",
                    autoplay: true,
                    showText: false,
                    allowFullScreen: true,
                    clickBehavior: "REDIRECT_TO_PAGE",
                    videoOrientation: imageType === 'vertical' ? 'PORTRAIT' : 'LANDSCAPE'
                }
            };
            
            showOutput(result);
            closeConfirmModal();
        }
        
        function showOutput(result) {
            document.getElementById('outputSection').innerHTML = `
                <div class="output-section">
                    <div class="output-header">
                        <span>âœ… ç”Ÿæˆå®Œæˆ</span>
                        <button class="btn" onclick="copyOutput()">ğŸ“‹ è¤‡è£½</button>
                    </div>
                    <div class="output-content" id="outputContent">${JSON.stringify(result, null, 2)}</div>
                </div>
            `;
        }
        
        function copyOutput() {
            const content = document.getElementById('outputContent').textContent;
            navigator.clipboard.writeText(content).then(() => {
                alert('é…ç½®å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            });
        }
        
        function openTemplateEditor() {
            const content = document.getElementById('templateEditorContent');
            content.innerHTML = '';
            
            ['horizontal', 'vertical'].forEach(type => {
                const typeDiv = document.createElement('div');
                typeDiv.innerHTML = `
                    <h4 style="margin: 16px 0 12px 0; color: #374151;">${type === 'horizontal' ? 'æ©«å¼ç‰ˆå‹' : 'ç›´å¼ç‰ˆå‹'}</h4>
                    ${templates[type].map((template, index) => `
                        <div class="template-editor">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div class="template-editor-title">${template.width}Ã—${template.height}</div>
                                <button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" 
                                        onclick="deleteTemplate('${type}', ${index})">ğŸ—‘ï¸ åˆªé™¤</button>
                            </div>
                            <div class="editor-row">
                                <input class="editor-input" placeholder="Width" value="${template.width}" 
                                       onchange="updateTemplate('${type}', ${index}, 'width', this.value)">
                                <input class="editor-input" placeholder="Height" value="${template.height}"
                                       onchange="updateTemplate('${type}', ${index}, 'height', this.value)">
                            </div>
                            <div class="editor-row">
                                <input class="editor-input" placeholder="Left" value="${template.liveStreamBox.left}"
                                       onchange="updateTemplate('${type}', ${index}, 'left', this.value)">
                                <input class="editor-input" placeholder="Top" value="${template.liveStreamBox.top}"
                                       onchange="updateTemplate('${type}', ${index}, 'top', this.value)">
                            </div>
                            <div class="editor-row">
                                <input class="editor-input" placeholder="StreamWidth" value="${template.liveStreamBox.width}"
                                       onchange="updateTemplate('${type}', ${index}, 'streamWidth', this.value)">
                                <input class="editor-input" placeholder="StreamHeight" value="${template.liveStreamBox.height}"
                                       onchange="updateTemplate('${type}', ${index}, 'streamHeight', this.value)">
                            </div>
                        </div>
                    `).join('')}
                `;
                content.appendChild(typeDiv);
            });
            
            document.getElementById('templateModal').style.display = 'block';
        }
        
        function updateTemplate(type, index, field, value) {
            if (field === 'width' || field === 'height') {
                templates[type][index][field] = parseInt(value) || 0;
            } else if (field === 'left' || field === 'top') {
                templates[type][index].liveStreamBox[field] = parseInt(value) || 0;
            } else if (field === 'streamWidth') {
                templates[type][index].liveStreamBox.width = parseInt(value) || 0;
            } else if (field === 'streamHeight') {
                templates[type][index].liveStreamBox.height = parseInt(value) || 0;
            }
        }
        
        function deleteTemplate(type, index) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ç‰ˆå‹å—ï¼Ÿ')) {
                templates[type].splice(index, 1);
                activeStatusTemplates = [...getUniqueTemplates()];
                saveTemplatesToStorage();
                openTemplateEditor(); // é‡æ–°æ‰“é–‹ç·¨è¼¯å™¨ä»¥æ›´æ–°é¡¯ç¤º
                updateTemplatesDisplay();
                updateStatus();
            }
        }
        
        function saveTemplates() {
            updateTemplatesDisplay();
            updateStatus();
            saveTemplatesToStorage();
            closeTemplateEditor();
            alert('ç‰ˆå‹å·²å„²å­˜ï¼');
        }
        
        function closeTemplateEditor() {
            document.getElementById('templateModal').style.display = 'none';
        }
        
        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }
        
        function startAutoCapture() {
            if (isMonitoring) return;
            
            isMonitoring = true;
            document.getElementById('captureStatus').textContent = 'ğŸ”„ ç›£è½ä¸­...';
            document.getElementById('captureStatus').style.color = '#3b82f6';
            
            if (!originalFetch) {
                originalFetch = window.fetch;
            }
            
            window.fetch = function(...args) {
                const result = originalFetch.apply(this, args);
                
                result.then(response => {
                    const url = args[0];
                    if (typeof url === 'string' && (
                        url.includes('/upload') || 
                        url.includes('/image') || 
                        url.includes('scupio.com')
                    )) {
                        const clonedResponse = response.clone();
                        clonedResponse.json().then(data => {
                            if (data && data.data && Array.isArray(data.data) && data.data.length > 0) {
                                const hasImageData = data.data.some(item => 
                                    item.id && item.width && item.height && item.filename
                                );
                                
                                if (hasImageData) {
                                    document.getElementById('apiResponse').value = JSON.stringify(data, null, 2);
                                    document.getElementById('captureStatus').textContent = 'âœ… å·²è‡ªå‹•æŠ“å–';
                                    document.getElementById('captureStatus').style.color = '#059669';
                                    
                                    currentImages = data.data;
                                    updateStatus();
                                    
                                    setTimeout(() => {
                                        if (document.getElementById('captureStatus')) {
                                            document.getElementById('captureStatus').style.color = '#6b7280';
                                        }
                                    }, 3000);
                                }
                            }
                        }).catch(() => {});
                    }
                }).catch(() => {});
                
                return result;
            };
        }
        
        function stopAutoCapture() {
            if (!isMonitoring) return;
            
            isMonitoring = false;
            document.getElementById('captureStatus').textContent = '';
            
            if (originalFetch) {
                window.fetch = originalFetch;
            }
        }
        
        document.getElementById('apiResponse').addEventListener('input', function() {
            try {
                const data = JSON.parse(this.value);
                if (data && data.data && Array.isArray(data.data)) {
                    currentImages = data.data;
                    updateStatus();
                }
            } catch (error) {
                // å¿½ç•¥ JSON è§£æéŒ¯èª¤
            }
        });
        
        document.getElementById('campaignName').addEventListener('input', function() {
            updateStatus();
        });
        
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });
    </script>
</body>
</html>